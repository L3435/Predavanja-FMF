name: Build LaTeX document
on: pull_request_target
jobs:
  check_file_changes:
    name: Preveri spremembe datotek
    runs-on: ubuntu-latest
    outputs:
      updated_tex_file: ${{ steps.changes.outputs.tex_file }}
    steps:
    
      - name: Set up Git repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.COMPILING_TOKEN }}
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          
      - name: Create filter
        uses: dorny/paths-filter@v2
        id: changes
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          filters: |
            tex_file:
              - '**.tex'
    
  compile_pdf:
    name: Compile document
    needs: check_file_changes
    if: needs.check_file_changes.outputs.updated_tex_file == 'true'
    
    runs-on: ubuntu-latest
    steps:
    
      - name: Set up Git repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.COMPILING_TOKEN }}
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          
      - name: Check if compiling is needed
        uses: dorny/paths-filter@v2
        id: filter
        with:
          working-directory: ${{ matrix.tex_file.path }}
          filters: |
            tex_file:
              - '${{ matrix.tex_file.path }}/**/*.tex'
            pdf_file:
              - '${{ matrix.tex_file.path }}/**/*.pdf'
              
      - name: Prvi pdflatex
        uses: xu-cheng/latex-action@v2
        with:
          root_file: |
            1. letnik/Algebra 1/Algebra 1.tex
            1. letnik/Analiza 1/Analiza 1.tex
            1. letnik/Logika in množice/Logika in množice.tex
            2. letnik/Algebra 2/Algebra 2.tex
            2. letnik/Analiza 2a/Analiza 2.tex
            2. letnik/Splošna topologija/Splošna topologija.tex
          compiler: pdflatex
          args: -interaction=nonstopmode
          
      - name: Bibliografija
        uses: xu-cheng/latex-action@v2
        with:
          root_file: |
            1. letnik/Algebra 1/Algebra 1.bcf
            1. letnik/Analiza 1/Analiza 1.bcf
            1. letnik/Logika in množice/Logika in množice.bcf
            2. letnik/Algebra 2/Algebra 2.bcf
            2. letnik/Analiza 2a/Analiza 2.bcf
            2. letnik/Splošna topologija/Splošna topologija.bcf
          compiler: biber
          args: ''

      - name: Stvarno kazalo
        uses: xu-cheng/latex-action@v2
        with:
          pre_compile: | 
            ls
          root_file: |
            1. letnik/Algebra 1/Algebra 1.idx
            1. letnik/Analiza 1/Analiza 1.idx
            1. letnik/Logika in množice/Logika in množice.idx
            2. letnik/Algebra 2/Algebra 2.idx
            2. letnik/Analiza 2a/Analiza 2.idx
            2. letnik/Splošna topologija/Splošna topologija.idx
          compiler: texindy
          args: -L slovenian -C utf8
          
      - name: Drugi pdflatex
        uses: xu-cheng/latex-action@v2
        with:
          root_file: |
            1. letnik/Algebra 1/Algebra 1.tex
            1. letnik/Analiza 1/Analiza 1.tex
            1. letnik/Logika in množice/Logika in množice.tex
            2. letnik/Algebra 2/Algebra 2.tex
            2. letnik/Analiza 2a/Analiza 2.tex
            2. letnik/Splošna topologija/Splošna topologija.tex
          compiler: pdflatex
          args: -interaction=nonstopmode
          
      - name: Tretji pdflatex
        uses: xu-cheng/latex-action@v2
        with:
          root_file: |
            1. letnik/Algebra 1/Algebra 1.tex
            1. letnik/Analiza 1/Analiza 1.tex
            1. letnik/Logika in množice/Logika in množice.tex
            2. letnik/Algebra 2/Algebra 2.tex
            2. letnik/Analiza 2a/Analiza 2.tex
            2. letnik/Splošna topologija/Splošna topologija.tex
          compiler: pdflatex
          args: -interaction=nonstopmode+
          
      - name: Shrani pdf datoteke
        uses: actions/upload-artifact@v2
        with:
          name: pdf-files
          path: |
            Algebra 1.pdf
            Analiza 1.pdf
            Logika in množice.pdf
            Algebra 2.pdf
            Analiza 2.pdf
            Splošna topologija.pdf
          
  push_pdfs:
    runs-on: ubuntu-latest
    needs: compile_pdf
  
    strategy:
      matrix:
        tex_file: [
          {path: '1. letnik/Algebra 1', file: 'Algebra 1'},
          {path: '1. letnik/Analiza 1', file: 'Analiza 1'},
          {path: '1. letnik/Logika in množice', file: 'Logika in množice'},
          {path: '2. letnik/Algebra 2', file: 'Algebra 2'},
          {path: '2. letnik/Analiza 2a', file: 'Analiza 2'},
          {path: '2. letnik/Splošna topologija', file: 'Splošna topologija'}
        ]
        
    steps:
    
      - name: Set up Git repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.COMPILING_TOKEN }}
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          
      - name: Check if pdf required
        uses: dorny/paths-filter@v2
        id: filter
        with:
          working-directory: ${{ matrix.tex_file.path }}
          filters: |
            tex_file:
              - '${{ matrix.tex_file.path }}/**/*.tex'
            pdf_file:
              - '${{ matrix.tex_file.path }}/**/*.pdf'
              
      - name: Download pdf
        if: steps.filter.outputs.tex_file == 'true' && steps.filter.outputs.pdf_file == 'false'
        uses: actions/download-artifact@v2
        with:
          name: pdf-files

      - name: Push pdf file
        if: steps.filter.outputs.tex_file == 'true' && steps.filter.outputs.pdf_file == 'false'
        run: |
            git config --global user.name "Luka Horjak"
            git config --global user.email "luka1.horjak@gmail.com"
            mv ${{ matrix.tex_file.file }}.pdf ${{ matrix.tex_file.path }}
            cd ${{ matrix.tex_file.path }}
            git add ${{ matrix.tex_file.file }}.pdf
            git commit -m "Dodan pdf - ${{ matrix.tex_file.file }}"
            git push origin ${{ github.event.pull_request.head.ref }}
  
  finish_job:
    name: Finish
    runs-on: ubuntu-latest
    needs: push_pdfs
    if: always()
    steps:
    
      - name: Fail if compilation failed
        if: ${{ needs.compile_pdf.result == 'failure' }}
        run: exit 1
        
      - name: Delete pdfs
        uses: geekyeggo/delete-artifact@v1
        with:
          name: pdf-files
            
      - name: Finish
        run: echo "Action complete"
        
